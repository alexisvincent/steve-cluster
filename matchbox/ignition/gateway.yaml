# storage:
#   disks:
#   - device: /dev/sda
#     wipe_table: true
#     partitions:
#     - label: ROOT
#   filesystems:
#   - mount:
#       device: /dev/disk/by-partlabel/ROOT
#       format: ext4
#       create:
#         force: true
#         options: [-L, ROOT]

passwd:
  users:
    - name: core
      password_hash: "$2a$10$1SoiF1NIXKhErUsY1XKDLOs9I4W9INvgowHQ5Ucrzrm9CUvX7/1yW"
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCk8CU3Bi1KFNcfQXpEdxz7HyfY1rh0MnuSVDFRTKcIIfboE5uMj0k7S/K1odIYFafs2Q8QgR/WmaZ15VAu9MvYfnmE9iPuB9PUa8YVkGeAxjIq929RICbYJCAgNen0lWqV9QQiulhU8A76Ot1CbNSIJgND4KbBUfZqjrCTO4lWbkisYwickbyi1j8FSTLcVmHkMYSOcFbueVXQrO6OXZQtLGa8HwRbY6kA3O6klzei1eMMzADLSjCuLKX7q0taYSQk80Joll2txD5bwId3SRvxZAenHrLZLkXzD7k68hxbpmTltMrwdAtOouNzyNuNCLaxEHUygQLxIBGEcOkFNA6e954GPMIf/IV6X4wmAnA9kqBbxGCC6b7KA+e2s8eusEWCA4lie1kJt4aQqImpquqpbft9wHDx16Qsh/Tqj7ZKG7bbPox82N2MRSl+RpxnOIjc8/xIFdrjELOH/zjI4milIT8BiSdGhQjk0ABTZWcVF9nf8eGxtw3oMKyYfhMrZ3+WRny0ut/4cyLwQJdbqi3so4sLJ51A6YLB4kpGRYRb8gChZZFh6uiwMPj057J9VOEbZE6hpQnXgatUMvmNfCFztj4+RmRiFo7l0YXz6DmocxqlEtXR2bOEVYq77Edc/YNDM5lIh5Wl3Bno0qsZ+KXoG7BASgP1qWBY5x25+nXwLQ== alexisvincent@Zeus.local

networkd:
  units:
    - name: gateway.network
      contents: |
        [Match]
        Name={|network.gateway.interface.internal|}

        [Network]
        DNS={|network.gateway.address.internal|}
        Address={|network.gateway.address.internal|}/{|network.subnet.short|}

systemd:
  units:
    - name: cluster-config.service
      enable: true
      contents: |
        [Unit]
        Description=Download the github repository containing cluster config
        Requires=network-online.target
        After=network-online.target

        [Service]
        ExecStart=-/usr/bin/git clone https://github.com/alexisvincent/steve-cluster-config /etc/cluster-config
        Restart=no

        [Install]
        WantedBy=multi-user.target

    - name: pynetkey.service
      enable: true
      contents: |
        [Unit]
        Description=Open pynetkey to enable internet access
        After=docker.service
        Requires=docker.service

        [Service]
        ExecStartPre=-/usr/bin/docker kill pynetkey
        ExecStartPre=-/usr/bin/docker rm pynetkey
        ExecStartPre=/usr/bin/curl -s http://{|network.bootstrapper.address.internal|}:8080/assets/pynetkey.tar > /etc/pynetkey.tar
        ExecStartPre=/usr/bin/curl -s http://{|network.bootstrapper.address.internal|}:8080/assets/pynetkey.config > /etc/pynetkey.config
        ExecStartPre=/usr/bin/docker load < /etc/pynetkey.tar
        ExecStart=/usr/bin/docker run \
          -v /etc/pynetkey.config:/etc/pynetkey.config
          --name=pynetkey alexisvincent/pynetkey -c /etc/pynetkey.config
        ExecStop=/usr/bin/docker stop pynetkey
        Restart=always

        [Install]
        WantedBy=multi-user.target

    - name: matchbox.service
      enable: true
      contents: |
        [Unit]
        Description=CoreOS matchbox Server
        After=docker.service cluster-config.service
        Requires=docker.service cluster-config.service

        [Service]
        Environment="MATCHBOX_PATH=/opt/cluster-config/matchbox"
        ExecStartPre=-/usr/bin/docker kill matchbox
        ExecStartPre=-/usr/bin/docker rm matchbox
        ExecStartPre=/usr/bin/docker pull quay.io/coreos/matchbox
        ExecStart=/usr/bin/docker run --name=matchbox --net=host \
          -v ${MATCHBOX_PATH}:/var/lib/matchbox:Z \
          -v ${MATCHBOX_PATH}/etc:/etc/matchbox:Z,ro \
          quay.io/coreos/matchbox \
            -address={|network.gateway.address.internal|}:8080 \
            -rpc-address={|network.gateway.address.internal|}:8081 \
            -log-level=debug \
            -assets-path=/var/lib/matchbox/assets
        ExecStop=/usr/bin/docker stop matchbox
        Restart=always
        
        [Install]
        WantedBy=multi-user.target

    - name: dnsmasq.service
      enable: true
      contents: |
        [Unit]
        Description=Run dnsmasq, providing dhcp, dns and network book
        After=docker.service matchbox.service
        Requires=docker.service matchbox.service

        [Service]
        Environment="IMAGE=quay.io/coreos/dnsmasq"
        Environment="FQDOMAIN={|network.gateway.hostname|}.{|network.domain|}"
        ExecStartPre=-/usr/bin/docker kill dnsmasq
        ExecStartPre=-/usr/bin/docker rm dnsmasq
        ExecStartPre=/usr/bin/docker pull ${IMAGE}
        ExecStart=/usr/bin/docker run --name=dnsmasq --cap-add=NET_ADMIN --net=host ${IMAGE} -d -q \
          --interface={|network.gateway.interface.internal|} \
          --dhcp-option=3,{|network.gateway.address.internal|} \
          --dhcp-range={|network.gateway.interface.internal|},{|network.dhcp.start|},{|network.dhcp.end|},12h \
          --enable-tftp --tftp-root=/var/lib/tftpboot \
          --dhcp-userclass=set:ipxe,iPXE \
          --dhcp-boot=tag:#ipxe,undionly.kpxe \
          --dhcp-boot=tag:ipxe,http://${FQDOMAIN}:8080/boot.ipxe \
          --address=/${FQDOMAIN}/{|network.gateway.address.internal|} \
          --log-queries \
          --log-dhcp
        ExecStop=/usr/bin/docker stop dnsmasq
        Restart=always

        [Install]
        WantedBy=multi-user.target
