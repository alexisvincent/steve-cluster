storage:
  disks:
  - device: /dev/sda
    wipe_table: true
    partitions:
    - label: ROOT
  filesystems:
  - mount:
      device: /dev/disk/by-partlabel/ROOT
      format: ext4
      create:
        force: true
        options: [-L, ROOT]

passwd:
  users:
    - name: alexisvincent
      password_hash: "$2a$10$1SoiF1NIXKhErUsY1XKDLOs9I4W9INvgowHQ5Ucrzrm9CUvX7/1yW"
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCk8CU3Bi1KFNcfQXpEdxz7HyfY1rh0MnuSVDFRTKcIIfboE5uMj0k7S/K1odIYFafs2Q8QgR/WmaZ15VAu9MvYfnmE9iPuB9PUa8YVkGeAxjIq929RICbYJCAgNen0lWqV9QQiulhU8A76Ot1CbNSIJgND4KbBUfZqjrCTO4lWbkisYwickbyi1j8FSTLcVmHkMYSOcFbueVXQrO6OXZQtLGa8HwRbY6kA3O6klzei1eMMzADLSjCuLKX7q0taYSQk80Joll2txD5bwId3SRvxZAenHrLZLkXzD7k68hxbpmTltMrwdAtOouNzyNuNCLaxEHUygQLxIBGEcOkFNA6e954GPMIf/IV6X4wmAnA9kqBbxGCC6b7KA+e2s8eusEWCA4lie1kJt4aQqImpquqpbft9wHDx16Qsh/Tqj7ZKG7bbPox82N2MRSl+RpxnOIjc8/xIFdrjELOH/zjI4milIT8BiSdGhQjk0ABTZWcVF9nf8eGxtw3oMKyYfhMrZ3+WRny0ut/4cyLwQJdbqi3so4sLJ51A6YLB4kpGRYRb8gChZZFh6uiwMPj057J9VOEbZE6hpQnXgatUMvmNfCFztj4+RmRiFo7l0YXz6DmocxqlEtXR2bOEVYq77Edc/YNDM5lIh5Wl3Bno0qsZ+KXoG7BASgP1qWBY5x25+nXwLQ== alexisvincent@Zeus.local

networkd:
  units:
    - name: 10-gateway.network
      contents: |
        [Match]
        Name=ens37

        [Network]
        DNS=10.10.0.1
        Address=10.10.0.1/16
        Gateway=192.168.1.1/24

systemd:
  units:
    - name: 10-dnsmasq.service
      enable: true
      contents: |
        [Unit]
        Description=Run dnsmasq, providing dhcp, dns and network book
        After=docker.service
        Requires=docker.service

        [Service]
        ExecStartPre=-/usr/bin/docker kill dnsmasq1
        ExecStartPre=-/usr/bin/docker rm dnsmasq1
        ExecStartPre=/usr/bin/docker pull quay.io/coreos/dnsmasq
        ExecStart=/usr/bin/docker run --name=dnsmasq1 --cap-add=NET_ADMIN --net=host quay.io/coreos/dnsmasq -d -q \
          --interface=ens37 \
          --dhcp-range=ens37,10.10.0.20,10.10.0.50,12h \
          --enable-tftp --tftp-root=/var/lib/tftpboot \
          --dhcp-userclass=set:ipxe,iPXE \
          --dhcp-boot=tag:#ipxe,undionly.kpxe \
          --dhcp-boot=tag:ipxe,http://matchbox.cluster:8080/boot.ipxe \
          --address=/matchbox.cluster/10.10.0.1 \
          --log-queries \
          --log-dhcp
        ExecStop=/usr/bin/docker stop dnsmasq1

        [Install]
        WantedBy=multi-user.target

    - name: 20-matchbox.service
      enable: true
      contents: |
        [Unit]
        Description=CoreOS matchbox Server
        Documentation=https://github.com/coreos/matchbox

        [Service]
        Environment="IMAGE=quay.io/coreos/matchbox"
        Environment="VERSION=v0.6.0"
        Environment="REPO_PATH=/home/core/steve-cluster"
        ExecStart=/usr/bin/docker run --net=host \
          -v ${REPO_PATH}/matchbox:/var/lib/matchbox:Z \
          -v ${REPO_PATH}/matchbox/etc:/etc/matchbox:Z,ro \
          ${IMAGE}:${VERSION} \
            -address=0.0.0.0:8080 \
            -rpc-address=0.0.0.0:8081 \
            -log-level=debug

        [Install]
        WantedBy=multi-user.target
