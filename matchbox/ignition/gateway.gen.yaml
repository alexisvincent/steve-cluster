# storage:
#   disks:
#   - device: /dev/sda
#     wipe_table: true
#     partitions:
#     - label: ROOT
#   filesystems:
#   - mount:
#       device: /dev/disk/by-partlabel/ROOT
#       format: ext4
#       create:
#         force: true
#         options: [-L, ROOT]

passwd:
  users:
    - name: core
      password_hash: "$2a$10$1SoiF1NIXKhErUsY1XKDLOs9I4W9INvgowHQ5Ucrzrm9CUvX7/1yW"
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCk8CU3Bi1KFNcfQXpEdxz7HyfY1rh0MnuSVDFRTKcIIfboE5uMj0k7S/K1odIYFafs2Q8QgR/WmaZ15VAu9MvYfnmE9iPuB9PUa8YVkGeAxjIq929RICbYJCAgNen0lWqV9QQiulhU8A76Ot1CbNSIJgND4KbBUfZqjrCTO4lWbkisYwickbyi1j8FSTLcVmHkMYSOcFbueVXQrO6OXZQtLGa8HwRbY6kA3O6klzei1eMMzADLSjCuLKX7q0taYSQk80Joll2txD5bwId3SRvxZAenHrLZLkXzD7k68hxbpmTltMrwdAtOouNzyNuNCLaxEHUygQLxIBGEcOkFNA6e954GPMIf/IV6X4wmAnA9kqBbxGCC6b7KA+e2s8eusEWCA4lie1kJt4aQqImpquqpbft9wHDx16Qsh/Tqj7ZKG7bbPox82N2MRSl+RpxnOIjc8/xIFdrjELOH/zjI4milIT8BiSdGhQjk0ABTZWcVF9nf8eGxtw3oMKyYfhMrZ3+WRny0ut/4cyLwQJdbqi3so4sLJ51A6YLB4kpGRYRb8gChZZFh6uiwMPj057J9VOEbZE6hpQnXgatUMvmNfCFztj4+RmRiFo7l0YXz6DmocxqlEtXR2bOEVYq77Edc/YNDM5lIh5Wl3Bno0qsZ+KXoG7BASgP1qWBY5x25+nXwLQ== alexisvincent@Zeus.local

storage:
  files:
    - path: /home/core/.ssh/bootstrapper
      filesystem: root
      contents:
        remote:
          url: http://10.10.0.2:8080/assets/keys/bootstrapper
    - path: /home/core/.ssh/bootstrapper.pub
      filesystem: root
      contents:
        remote:
          url: http://10.10.0.2:8080/assets/keys/bootstrapper.pub

networkd:
  units:
    - name: gateway.network
      contents: |
        [Match]
        Name=eno1

        [Network]
        DNS=10.10.0.1
        Address=10.10.0.1/16
        IPForward=ipv4
        IPMasquerade=yes

systemd:
  units:
    - name: download-assets.service
      enable: true
      contents: |
        [Unit]
        Description=Download the github repository containing cluster config
        Requires=network-online.target
        After=network-online.target

        [Service]
        ExecStart=-/usr/bin/rsync -Pza core@10.10.0.2:/opt/cluster-config/ /opt/cluster-config
        Restart=no

        [Install]
        WantedBy=multi-user.target

    - name: pynetkey.service
      enable: true
      contents: |
        [Unit]
        Description=Open pynetkey to enable internet access
        After=download-assets.service
        Requires=download-assets.service

        [Service]
        ExecStartPre=-/usr/bin/docker kill pynetkey
        ExecStartPre=-/usr/bin/docker rm pynetkey
        ExecStartPre=/usr/bin/sh -c '/usr/bin/docker load < /opt/cluster-config/matchbox/assets/pynetkey.tar'
        ExecStart=/usr/bin/docker run \
          --net=host \
          -v /opt/cluster-config/matchbox/assets/pynetkey.config:/etc/pynetkey.config \
          --name=pynetkey alexisvincent/pynetkey -c /etc/pynetkey.config
        ExecStop=/usr/bin/docker stop pynetkey
        Restart=always

        [Install]
        WantedBy=multi-user.target

    - name: matchbox.service
      enable: true
      contents: |
        [Unit]
        Description=CoreOS matchbox Server
        After=docker.service download-assets.service
        Requires=docker.service download-assets.service

        [Service]
        Environment="MATCHBOX_PATH=/opt/cluster-config/matchbox"
        ExecStartPre=-/usr/bin/docker kill matchbox
        ExecStartPre=-/usr/bin/docker rm matchbox
        ExecStartPre=/usr/bin/docker pull quay.io/coreos/matchbox
        ExecStart=/usr/bin/docker run --name=matchbox --net=host \
          -v ${MATCHBOX_PATH}:/var/lib/matchbox:Z \
          -v ${MATCHBOX_PATH}/etc:/etc/matchbox:Z,ro \
          quay.io/coreos/matchbox \
            -address=10.10.0.1:8080 \
            -rpc-address=10.10.0.1:8081 \
            -log-level=debug \
            -assets-path=/var/lib/matchbox/assets
        ExecStop=/usr/bin/docker stop matchbox
        Restart=always
        
        [Install]
        WantedBy=multi-user.target

    - name: dnsmasq.service
      enable: true
      contents: |
        [Unit]
        Description=Run dnsmasq, providing dhcp, dns and network book
        After=docker.service matchbox.service
        Requires=docker.service matchbox.service

        [Service]
        Environment="IMAGE=quay.io/coreos/dnsmasq"
        Environment="FQDOMAIN=gateway.steve"
        ExecStartPre=-/usr/bin/docker kill dnsmasq
        ExecStartPre=-/usr/bin/docker rm dnsmasq
        ExecStartPre=/usr/bin/docker pull ${IMAGE}
        ExecStart=/usr/bin/docker run --name=dnsmasq --cap-add=NET_ADMIN --net=host ${IMAGE} -d -q \
          --interface=eno1 \
          --dhcp-option=3,10.10.0.1 \
          --dhcp-range=eno1,10.10.0.50,10.10.0.100,12h \
          --enable-tftp --tftp-root=/var/lib/tftpboot \
          --dhcp-userclass=set:ipxe,iPXE \
          --dhcp-boot=tag:#ipxe,undionly.kpxe \
          --dhcp-boot=tag:ipxe,http://${FQDOMAIN}:8080/boot.ipxe \
          --address=/${FQDOMAIN}/10.10.0.1 \
          --log-queries \
          --log-dhcp
        ExecStop=/usr/bin/docker stop dnsmasq
        Restart=always

        [Install]
        WantedBy=multi-user.target
